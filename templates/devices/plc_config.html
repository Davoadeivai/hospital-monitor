{% extends 'base/base.html' %}
{% block title %}Ø§ØªØµØ§Ù„ PLC â€” {{ device.name }}{% endblock %}
{% block breadcrumb %}DEVICES / PLC CONNECTION{% endblock %}

{% block extra_css %}
<style>
.conn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-5); }
.tab-buttons { display: flex; gap: var(--space-2); margin-bottom: var(--space-6); }
.tab-btn {
  flex: 1; padding: var(--space-4); border-radius: var(--radius-md);
  border: 1px solid var(--border-default); background: var(--surface-2);
  color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
  text-align: center; font-family: var(--font-mono); font-size: 11px;
  letter-spacing: 1px; text-transform: uppercase;
}
.tab-btn.active {
  background: var(--acid-glow); border-color: var(--acid);
  color: var(--acid);
}
.tab-content { display: none; }
.tab-content.active { display: block; }

.register-table td:first-child {
  font-family: var(--font-mono); color: var(--plasma); font-size: 12px; font-weight: 700;
}
.register-table td:last-child { color: var(--text-tertiary); font-size: 11px; }

.wiring-diagram {
  background: var(--void); border: 1px solid var(--border-default);
  border-radius: var(--radius-lg); padding: var(--space-6);
  font-family: var(--font-mono); font-size: 12px; line-height: 2.2;
  color: var(--text-secondary);
}

.wire-label { display: inline-block; width: 60px; text-align: left; }
.wire-a { color: var(--crimson); font-weight: 700; }
.wire-b { color: #444; font-weight: 700; }
.wire-gnd { color: var(--acid); }
.arrow { color: var(--text-tertiary); }

.test-result {
  background: var(--surface-2); border: 1px solid var(--border-default);
  border-radius: var(--radius-md); padding: var(--space-5);
  font-family: var(--font-mono); font-size: 12px; line-height: 2;
  min-height: 100px;
}
</style>
{% endblock %}

{% block content %}

<div class="page-header fade-up">
  <div class="page-title-group">
    <div class="page-eyebrow">PLC / MODBUS CONNECTION</div>
    <h1 class="page-title">Ø§ØªØµØ§Ù„ Ø¨Ù‡ PLC â€” {{ device.name }}</h1>
    <p class="page-subtitle">
      PLC: COTRUST CT Series &nbsp;|&nbsp; HMI: FATEK FBTNxx &nbsp;|&nbsp;
      <span class="badge {% if device.connection_type == 'sim' %}badge-ghost{% else %}badge-green{% endif %}">
        {{ device.get_connection_type_display }}
      </span>
    </p>
  </div>
  <a href="/monitor/{{ device.pk }}/" class="btn btn-ghost">
    <i class="fas fa-arrow-right me-2"></i>Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø§Ù†ÛŒØªÙˆØ±
  </a>
</div>

<!-- ===== CONNECTION TYPE TABS ===== -->
<div class="panel fade-up stagger-1">
  <div class="panel-header">
    <div class="panel-title">âš™ï¸ Ù†ÙˆØ¹ Ø§ØªØµØ§Ù„ Ø¨Ù‡ PLC</div>
  </div>
  <div class="panel-body">

    <div class="tab-buttons">
      <button class="tab-btn {% if device.connection_type == 'sim' %}active{% endif %}"
              onclick="switchTab('sim', this)">
        ğŸ® Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²<br><span style="font-size:9px;opacity:0.7">Ø¨Ø±Ø§ÛŒ ØªØ³Øª</span>
      </button>
      <button class="tab-btn {% if device.connection_type == 'rtu' %}active{% endif %}"
              onclick="switchTab('rtu', this)">
        ğŸ”Œ Modbus RTU<br><span style="font-size:9px;opacity:0.7">RS485 Ú©Ø§Ø¨Ù„</span>
      </button>
      <button class="tab-btn {% if device.connection_type == 'tcp' %}active{% endif %}"
              onclick="switchTab('tcp', this)">
        ğŸŒ Modbus TCP<br><span style="font-size:9px;opacity:0.7">Ø´Ø¨Ú©Ù‡ Ethernet</span>
      </button>
    </div>

    <form method="post" action="/devices/{{ device.pk }}/plc-config/" id="plc-form">
      {% csrf_token %}
      <input type="hidden" name="connection_type" id="conn_type_input" value="{{ device.connection_type }}">

      <!-- SIM TAB -->
      <div class="tab-content {% if device.connection_type == 'sim' %}active{% endif %}" id="tab-sim">
        <div style="text-align:center;padding:var(--space-8);color:var(--text-secondary)">
          <div style="font-size:48px;margin-bottom:var(--space-4)">ğŸ®</div>
          <div style="font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--text-primary);margin-bottom:var(--space-2)">
            Ø­Ø§Ù„Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²
          </div>
          <div style="font-size:13px;max-width:400px;margin:0 auto;line-height:1.7">
            Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø± â€” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹â€ŒÚ¯Ø±Ø§ÛŒØ§Ù†Ù‡ Ø³ÛŒÚ©Ù„ Ø§ØªÙˆÚ©Ù„Ø§Ùˆ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´Ù‡.
            ÙˆÙ‚ØªÛŒ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø± Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ RTU ÛŒØ§ TCP ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒØ¯.
          </div>
        </div>
      </div>

      <!-- RTU TAB -->
      <div class="tab-content {% if device.connection_type == 'rtu' %}active{% endif %}" id="tab-rtu">
        <div class="conn-grid">
          <div>
            <div class="form-group">
              <label class="form-label">Ù¾ÙˆØ±Øª Ø³Ø±ÛŒØ§Ù„</label>
              <input type="text" name="serial_port" class="form-control"
                     value="{{ device.serial_port }}"
                     placeholder="/dev/ttyUSB0 ÛŒØ§ COM3">
              <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);margin-top:4px">
                Linux: /dev/ttyUSB0 &nbsp;|&nbsp; Windows: COM3
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Baud Rate</label>
              <select name="baud_rate" class="form-control">
                {% for br in "9600,19200,38400,57600,115200".split(",") %}
                <option value="{{ br }}" {% if device.baud_rate|stringformat:"s" == br %}selected{% endif %}>{{ br }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Slave ID</label>
              <input type="number" name="modbus_slave_id" class="form-control"
                     value="{{ device.modbus_slave_id }}" min="1" max="247">
            </div>
            <div class="form-group">
              <label class="form-label">ÙØ§ØµÙ„Ù‡ polling (Ø«Ø§Ù†ÛŒÙ‡)</label>
              <input type="number" name="polling_interval" class="form-control"
                     value="{{ device.polling_interval }}" min="1" max="60">
            </div>
          </div>

          <!-- Wiring Diagram -->
          <div>
            <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);letter-spacing:2px;text-transform:uppercase;margin-bottom:var(--space-3)">
              Ù†Ù‚Ø´Ù‡ Ø³ÛŒÙ…â€ŒÚ©Ø´ÛŒ RS485
            </div>
            <div class="wiring-diagram">
              <div>Ù…Ø¨Ø¯Ù„ USB-RS485</div>
              <div>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
              <div>â”‚ <span class="wire-a">A+</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ <span class="wire-a">A+</span> PLC COTRUST â”‚</div>
              <div>â”‚ <span class="wire-b" style="color:var(--text-tertiary)">B-</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ <span class="wire-b" style="color:var(--text-tertiary)">B-</span> PLC COTRUST â”‚</div>
              <div>â”‚ <span class="wire-gnd">GND</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ <span class="wire-gnd">GND</span> PLC         â”‚</div>
              <div>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
              <div style="margin-top:var(--space-3);color:var(--text-tertiary)">
                âš ï¸ Ù…Ù‚Ø§ÙˆÙ…Øª Ù¾Ø§ÛŒØ§Ù†ÛŒ 120Î© Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ø®Ø· RS485<br>
                âš ï¸ Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ú©Ø§Ø¨Ù„: 1200 Ù…ØªØ± @ 9600 baud
              </div>
            </div>

            <div style="margin-top:var(--space-4);background:var(--amber-glow);border:1px solid rgba(255,184,0,0.2);border-radius:var(--radius-md);padding:var(--space-3)">
              <div style="font-family:var(--font-mono);font-size:10px;color:var(--amber);margin-bottom:4px">âš™ï¸ ØªÙ†Ø¸ÛŒÙ… PLC COTRUST</div>
              <div style="font-size:12px;color:var(--text-secondary);line-height:1.7">
                Ø¯Ø± Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± COTRUST:<br>
                Communication â†’ Serial â†’ Mode: RTU<br>
                Baud: {{ device.baud_rate }} &nbsp;|&nbsp; Parity: None &nbsp;|&nbsp; Station: {{ device.modbus_slave_id }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TCP TAB -->
      <div class="tab-content {% if device.connection_type == 'tcp' %}active{% endif %}" id="tab-tcp">
        <div class="conn-grid">
          <div>
            <div class="form-group">
              <label class="form-label">Ø¢Ø¯Ø±Ø³ IP Ù¾ÛŒâ€ŒØ§Ù„â€ŒØ³ÛŒ</label>
              <input type="text" name="plc_ip" class="form-control"
                     value="{{ device.plc_ip|default:'' }}"
                     placeholder="192.168.1.100">
            </div>
            <div class="form-group">
              <label class="form-label">Ù¾ÙˆØ±Øª Modbus TCP</label>
              <input type="number" name="plc_port" class="form-control"
                     value="{{ device.plc_port }}" placeholder="502">
            </div>
            <div class="form-group">
              <label class="form-label">Slave ID</label>
              <input type="number" name="modbus_slave_id" class="form-control"
                     value="{{ device.modbus_slave_id }}" min="1" max="247">
            </div>
            <div class="form-group">
              <label class="form-label">ÙØ§ØµÙ„Ù‡ polling (Ø«Ø§Ù†ÛŒÙ‡)</label>
              <input type="number" name="polling_interval" class="form-control"
                     value="{{ device.polling_interval }}" min="1" max="60">
            </div>
          </div>

          <div>
            <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);letter-spacing:2px;text-transform:uppercase;margin-bottom:var(--space-3)">
              Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¨Ú©Ù‡
            </div>
            <div class="wiring-diagram">
              <div>Server / Raspberry Pi</div>
              <div>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
              <div>â”‚ LAN Port â”€â”€Switchâ”€â”€â†’ LAN Port PLC â”‚</div>
              <div>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
              <div style="margin-top:var(--space-3);color:var(--text-tertiary)">
                IP Ù¾ÛŒâ€ŒØ§Ù„â€ŒØ³ÛŒ: {{ device.plc_ip|default:"192.168.1.100" }}<br>
                Port: {{ device.plc_port }}<br>
                Protocol: Modbus TCP (FC03/FC05)
              </div>
            </div>

            <div style="margin-top:var(--space-4);background:var(--plasma-glow);border:1px solid rgba(0,212,255,0.2);border-radius:var(--radius-md);padding:var(--space-3)">
              <div style="font-family:var(--font-mono);font-size:10px;color:var(--plasma);margin-bottom:4px">âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ù…Ø§Ú˜ÙˆÙ„ Ethernet COTRUST</div>
              <div style="font-size:12px;color:var(--text-secondary);line-height:1.7">
                Ø¯Ø± Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± COTRUST:<br>
                Ethernet â†’ IP: {{ device.plc_ip|default:"192.168.1.100" }}<br>
                Subnet: 255.255.255.0 &nbsp;|&nbsp; Gateway: 192.168.1.1<br>
                Modbus TCP Server: Enable
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:var(--space-3);justify-content:flex-end;margin-top:var(--space-6)">
        <button type="button" class="btn btn-ghost" onclick="testConnection()">
          <i class="fas fa-plug me-2"></i>ØªØ³Øª Ø§ØªØµØ§Ù„
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-2"></i>Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        </button>
      </div>
    </form>

  </div>
</div>

<!-- ===== TEST RESULT ===== -->
<div class="panel mt-6 fade-up stagger-2" id="test-panel" style="display:none">
  <div class="panel-header">
    <div class="panel-title">ğŸ”Œ Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª Ø§ØªØµØ§Ù„</div>
    <div class="live-ticker"><div class="live-ticker-dot"></div><span style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary)">Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...</span></div>
  </div>
  <div class="panel-body">
    <div class="test-result" id="test-output">
      <span style="color:var(--text-tertiary)">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Øª...</span>
    </div>

    <div id="live-data" style="display:none;margin-top:var(--space-4)">
      <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);letter-spacing:2px;margin-bottom:var(--space-3)">Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² PLC:</div>
      <div class="gauge-grid" style="grid-template-columns:repeat(4,1fr)">
        <div class="gauge-card normal">
          <div class="gauge-label">TEMPERATURE</div>
          <div class="gauge-value" id="t-temp">â€”</div>
          <div class="gauge-unit">Â°C</div>
        </div>
        <div class="gauge-card normal">
          <div class="gauge-label">PRESSURE</div>
          <div class="gauge-value" id="t-press">â€”</div>
          <div class="gauge-unit">bar</div>
        </div>
        <div class="gauge-card normal">
          <div class="gauge-label">POWER</div>
          <div class="gauge-value" id="t-power">â€”</div>
          <div class="gauge-unit">kW</div>
        </div>
        <div class="gauge-card normal">
          <div class="gauge-label">STATUS</div>
          <div class="gauge-value" style="font-size:20px" id="t-status">â€”</div>
          <div class="gauge-unit">PHASE</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== REGISTER MAP ===== -->
<div class="panel mt-6 fade-up stagger-3">
  <div class="panel-header">
    <div>
      <div class="panel-title">ğŸ“‹ Ù†Ù‚Ø´Ù‡ Ø±Ø¬ÛŒØ³ØªØ±Ù‡Ø§ÛŒ Modbus</div>
      <div class="panel-subtitle">MODBUS REGISTER MAP â€” COTRUST PLC</div>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="copyRegMap()">
      <i class="fas fa-copy me-2"></i>Ú©Ù¾ÛŒ
    </button>
  </div>
  <div class="panel-body" style="padding:0">
    <table class="data-table register-table">
      <thead>
        <tr>
          <th>Ø¢Ø¯Ø±Ø³ (D)</th>
          <th>Ù¾Ø§Ø±Ø§Ù…ØªØ±</th>
          <th>Ù…Ù‚ÛŒØ§Ø³</th>
          <th>Ù…Ø«Ø§Ù„</th>
          <th>ØªÙˆØ¶ÛŒØ­</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>D0</td><td class="td-primary">Ø¯Ù…Ø§</td><td class="td-mono">Ã— 10</td><td class="td-mono td-accent">1215</td><td>= 121.5Â°C</td></tr>
        <tr><td>D1</td><td class="td-primary">ÙØ´Ø§Ø±</td><td class="td-mono">Ã— 100</td><td class="td-mono td-accent">152</td><td>= 1.52 bar</td></tr>
        <tr><td>D2</td><td class="td-primary">Ø¬Ø±ÛŒØ§Ù† Ø¨Ø®Ø§Ø±</td><td class="td-mono">Ã— 10</td><td class="td-mono td-accent">82</td><td>= 8.2 kg/h</td></tr>
        <tr><td>D3</td><td class="td-primary">Ø³Ø·Ø­ Ø¢Ø¨</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">74</td><td>= 74%</td></tr>
        <tr><td>D4</td><td class="td-primary">Ù…ØµØ±Ù Ø¨Ø±Ù‚</td><td class="td-mono">Ã— 10</td><td class="td-mono td-accent">148</td><td>= 14.8 kW</td></tr>
        <tr><td>D5</td><td class="td-primary">ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒÚ©Ù„</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">2</td><td>0=Idle 1=Heating 2=Sterilizing 3=Cooling 4=Complete 5=Error</td></tr>
        <tr><td>D6</td><td class="td-primary">ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">1</td><td>0=Ø¨Ø§Ø² 1=Ù‚ÙÙ„</td></tr>
        <tr><td>D7</td><td class="td-primary">ÙˆØ¶Ø¹ÛŒØª Ø§Ù„Ù…Ù†Øª</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">1</td><td>0=Ø®Ø§Ù…ÙˆØ´ 1=Ø±ÙˆØ´Ù†</td></tr>
        <tr><td>D8</td><td class="td-primary">ÙˆØ¶Ø¹ÛŒØª Ù¾Ù…Ù¾</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">1</td><td>0=Ø®Ø§Ù…ÙˆØ´ 1=Ø±ÙˆØ´Ù†</td></tr>
        <tr><td>D9</td><td class="td-primary">Ø´Ù…Ø§Ø±Ù‡ Ø³ÛŒÚ©Ù„ Ø¬Ø§Ø±ÛŒ</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">847</td><td>Ø´Ù…Ø§Ø±Ù‡ Ø³ÛŒÚ©Ù„ ÙØ¹Ø§Ù„</td></tr>
        <tr><td>D10</td><td class="td-primary">Ú©Ù„ Ø³ÛŒÚ©Ù„â€ŒÙ‡Ø§</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">2143</td><td>Ø·ÙˆÙ„ Ø¹Ù…Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡</td></tr>
        <tr><td>D11</td><td class="td-primary">Ú©Ø¯ Ù‡Ø´Ø¯Ø§Ø±</td><td class="td-mono">Ã— 1</td><td class="td-mono td-accent">0</td><td>0=Normal, 1-11=Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù</td></tr>
      </tbody>
    </table>
    <div style="padding:var(--space-4) var(--space-6);border-top:1px solid var(--border-subtle)">
      <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);letter-spacing:1px;margin-bottom:var(--space-2)">COIL MAP (Outputs Ø§Ø² Django Ø¨Ù‡ PLC):</div>
      <div style="display:flex;gap:var(--space-6);font-size:12px;color:var(--text-secondary)">
        <span><span style="color:var(--plasma);font-family:var(--font-mono)">M0</span> = Ø´Ø±ÙˆØ¹ Ø³ÛŒÚ©Ù„ Ø§Ø² Ø±Ø§Ù‡ Ø¯ÙˆØ±</span>
        <span><span style="color:var(--plasma);font-family:var(--font-mono)">M1</span> = ØªÙˆÙ‚Ù/Ù„ØºÙˆ Ø³ÛŒÚ©Ù„</span>
        <span><span style="color:var(--plasma);font-family:var(--font-mono)">M2</span> = Ù‚ÙÙ„ Ø¯Ø±</span>
        <span><span style="color:var(--plasma);font-family:var(--font-mono)">M3</span> = Ø±ÛŒØ³Øª Ù‡Ø´Ø¯Ø§Ø±</span>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function switchTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  document.getElementById('conn_type_input').value = name;
}

async function testConnection() {
  const panel = document.getElementById('test-panel');
  const output = document.getElementById('test-output');
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth' });

  output.innerHTML = '<span style="color:var(--amber)">â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>';

  try {
    const res = await fetch('/devices/{{ device.pk }}/plc-test/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrf() }
    });
    const data = await res.json();

    if (data.success) {
      const r = data.reading;
      output.innerHTML = `
        <span style="color:var(--acid)">âœ… Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚</span><br>
        <span style="color:var(--text-tertiary)">Ø¯Ù…Ø§: </span><span style="color:var(--fire)">${r.temperature}Â°C</span> &nbsp;
        <span style="color:var(--text-tertiary)">ÙØ´Ø§Ø±: </span><span style="color:var(--plasma)">${r.pressure} bar</span> &nbsp;
        <span style="color:var(--text-tertiary)">Ø¨Ø±Ù‚: </span><span style="color:var(--amber)">${r.power} kW</span><br>
        <span style="color:var(--text-tertiary)">ÙˆØ¶Ø¹ÛŒØª: </span><span style="color:var(--text-primary)">${r.status}</span> &nbsp;
        <span style="color:var(--text-tertiary)">Ù‡Ø´Ø¯Ø§Ø±: </span><span style="color:${r.alarm_code ? 'var(--crimson)' : 'var(--acid)'}">${r.alarm_message || 'Normal'}</span>
      `;
      document.getElementById('live-data').style.display = 'block';
      document.getElementById('t-temp').textContent = r.temperature;
      document.getElementById('t-press').textContent = r.pressure;
      document.getElementById('t-power').textContent = r.power;
      document.getElementById('t-status').textContent = r.status.toUpperCase();
      showToast('Ø§ØªØµØ§Ù„ Ø¨Ù‡ PLC Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯', 'success');
    } else {
      output.innerHTML = `<span style="color:var(--crimson)">âŒ ${data.error}</span><br>
        <span style="color:var(--text-tertiary)">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªØ³Øª Ú©Ù†ÛŒØ¯.</span>`;
      showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ PLC', 'error');
    }
  } catch(e) {
    output.innerHTML = `<span style="color:var(--crimson)">âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${e.message}</span>`;
  }
}

function copyRegMap() {
  const map = `D0=Ø¯Ù…Ø§(Ã—10), D1=ÙØ´Ø§Ø±(Ã—100), D2=Ø¬Ø±ÛŒØ§Ù† Ø¨Ø®Ø§Ø±(Ã—10), D3=Ø³Ø·Ø­ Ø¢Ø¨, D4=Ø¨Ø±Ù‚(Ã—10), D5=ÙˆØ¶Ø¹ÛŒØª, D6=Ø¯Ø±, D7=Ø§Ù„Ù…Ù†Øª, D8=Ù¾Ù…Ù¾, D9=Ø´Ù…Ø§Ø±Ù‡ Ø³ÛŒÚ©Ù„, D10=Ú©Ù„ Ø³ÛŒÚ©Ù„, D11=Ú©Ø¯ Ù‡Ø´Ø¯Ø§Ø±`;
  navigator.clipboard.writeText(map);
  showToast('Ù†Ù‚Ø´Ù‡ Ø±Ø¬ÛŒØ³ØªØ±Ù‡Ø§ Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
}
</script>
{% endblock %}
