<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#050709">
  <title>{% block title %}HospitalOS{% endblock %} â€” Hospital Monitor</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Main CSS -->
  <link rel="stylesheet" href="/static/css/main.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Lucide Icons (lightweight) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  {% block extra_css %}{% endblock %}
</head>
<body>

<div class="app-shell">

  <!-- Sidebar Overlay (Mobile) -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- ============ SIDEBAR ============ -->
  <nav class="sidebar" id="sidebar">

    <div class="sidebar-brand">
      <div class="brand-mark">
        <div class="brand-icon">âš•ï¸</div>
        <div>
          <div class="brand-name">HospitalOS</div>
          <div class="brand-sub">Monitor v2.0</div>
        </div>
      </div>
      <div class="system-status">
        <div class="status-led" id="sys-led"></div>
        <span id="sys-status-text" style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary)">SYSTEM ONLINE</span>
      </div>
    </div>

    <nav class="sidebar-nav">

      <div class="nav-section">
        <div class="nav-section-label">OVERVIEW</div>
        <a href="/" class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
          <span class="nav-icon"><i class="fas fa-th-large"></i></span>
          Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ù„ÛŒ
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-label">DEVICES</div>
        <a href="/devices/" class="nav-item {% if 'device' in request.resolver_match.url_name|default:'' %}active{% endif %}">
          <span class="nav-icon"><i class="fas fa-microchip"></i></span>
          ØªØ¬Ù‡ÛŒØ²Ø§Øª
        </a>
        <a href="/devices/?type=autoclave" class="nav-item">
          <span class="nav-icon"><i class="fas fa-flask"></i></span>
          Ø§ØªÙˆÚ©Ù„Ø§ÙˆÙ‡Ø§
        </a>
        <a href="/devices/?type=incinerator" class="nav-item">
          <span class="nav-icon"><i class="fas fa-fire"></i></span>
          Ø²Ø¨Ø§Ù„Ù‡â€ŒØ³ÙˆØ²Ù‡Ø§
        </a>
        <a href="/devices/maintenance/" class="nav-item">
          <span class="nav-icon"><i class="fas fa-tools"></i></span>
          Ø³Ø±ÙˆÛŒØ³ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-label">ANALYTICS</div>
        <a href="/energy/" class="nav-item {% if 'energy' in request.resolver_match.url_name|default:'' %}active{% endif %}">
          <span class="nav-icon"><i class="fas fa-bolt"></i></span>
          Ù…ØµØ±Ù Ø§Ù†Ø±Ú˜ÛŒ
        </a>
        <a href="/costs/" class="nav-item {% if 'cost' in request.resolver_match.url_name|default:'' %}active{% endif %}">
          <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
          Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
        </a>
        <a href="/waste/" class="nav-item">
          <span class="nav-icon"><i class="fas fa-trash-alt"></i></span>
          Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ø¨Ø§Ù„Ù‡
        </a>
        <a href="/energy/tariffs/" class="nav-item">
          <span class="nav-icon"><i class="fas fa-tags"></i></span>
          ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-label">OPERATIONS</div>
        <a href="/alerts/" class="nav-item {% if 'alert' in request.resolver_match.url_name|default:'' %}active{% endif %}">
          <span class="nav-icon"><i class="fas fa-bell"></i></span>
          Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
          {% if unresolved_alerts_count %}
          <span class="nav-badge">{{ unresolved_alerts_count }}</span>
          {% endif %}
        </a>
        <a href="/reports/monthly/" class="nav-item">
          <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
          Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡
        </a>
        <a href="/reports/export/" class="nav-item">
          <span class="nav-icon"><i class="fas fa-file-excel"></i></span>
          Ø®Ø±ÙˆØ¬ÛŒ Excel
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-label">SYSTEM</div>
        <a href="/admin/" class="nav-item">
          <span class="nav-icon"><i class="fas fa-shield-alt"></i></span>
          Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
        </a>
      </div>

    </nav>

    <div class="sidebar-footer">
      <div class="user-avatar">ğŸ‘¤</div>
      <div class="user-info">
        <div class="user-name">{{ request.user.get_full_name|default:request.user.username }}</div>
        <div class="user-role">{% if request.user.is_superuser %}ADMIN{% else %}OPERATOR{% endif %}</div>
      </div>
      <a href="/accounts/logout/" class="btn btn-ghost btn-icon btn-sm" title="Ø®Ø±ÙˆØ¬">
        <i class="fas fa-sign-out-alt"></i>
      </a>
    </div>

  </nav>

  <!-- ============ MAIN ============ -->
  <div class="main-content">

    <!-- Topbar -->
    <header class="topbar">
      <button class="btn btn-ghost btn-icon btn-sm" id="sidebar-toggle" onclick="toggleSidebar()" style="display:none">
        <i class="fas fa-bars"></i>
      </button>

      <div class="topbar-breadcrumb">
        <span class="breadcrumb-parent">HOSPITAL MONITOR</span>
        <span class="breadcrumb-sep">/</span>
        <span class="breadcrumb-current">{% block breadcrumb %}DASHBOARD{% endblock %}</span>
      </div>

      <div class="topbar-right">
        {% if unresolved_alerts_count %}
        <a href="/alerts/" class="btn btn-danger btn-sm">
          <i class="fas fa-bell"></i> {{ unresolved_alerts_count }} Ù‡Ø´Ø¯Ø§Ø± ÙØ¹Ø§Ù„
        </a>
        {% endif %}

        <div class="live-ticker">
          <div class="live-ticker-dot"></div>
          <span id="topbar-clock" class="topbar-clock" style="font-family:var(--font-mono);font-size:11px;color:var(--text-tertiary)">--:--:--</span>
        </div>
      </div>
    </header>

    <!-- Page Content -->
    <main class="page-content">
      {% block content %}{% endblock %}
    </main>

  </div>

</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- ============ GLOBAL JS ============ -->
<script>
// ===== Clock =====
function updateClock() {
  const now = new Date();
  document.getElementById('topbar-clock').textContent =
    now.toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

// ===== Sidebar Toggle (Mobile) =====
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('show');
}

// Check mobile and resize
function checkMobile() {
  const btn = document.getElementById('sidebar-toggle');
  if (window.innerWidth <= 768) {
    btn.style.display = 'flex';
  } else {
    btn.style.display = 'none';
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').classList.remove('show');
  }
}
window.addEventListener('resize', checkMobile);
checkMobile();

// ===== Toast System =====
function showToast(msg, type = 'success', duration = 4000) {
  const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ' };
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span style="font-size:16px;font-weight:700;color:var(--${type === 'success' ? 'acid' : type === 'error' ? 'crimson' : 'amber'})">${icons[type]}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'toast-in 0.3s var(--ease-spring) reverse';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// ===== CSRF Helper =====
function getCsrf() {
  return document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
}

// ===== API Helper =====
async function apiPost(url, data = {}) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
    body: JSON.stringify(data)
  });
  return res.json();
}

async function apiGet(url) {
  const res = await fetch(url);
  return res.json();
}

// ===== Alert Resolve =====
async function resolveAlert(id, btn) {
  try {
    const res = await fetch(`/alerts/resolve/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrf() }
    });
    if (res.ok) {
      const item = btn.closest('.alert-item');
      item.style.transition = 'all 0.4s';
      item.style.opacity = '0';
      item.style.transform = 'translateX(-20px)';
      setTimeout(() => item.remove(), 400);
      showToast('Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±ÙØ¹ Ø´Ø¯', 'success');
    }
  } catch(e) {
    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø±ÙØ¹ Ù‡Ø´Ø¯Ø§Ø±', 'error');
  }
}

// ===== Lucide Icons =====
if (typeof lucide !== 'undefined') lucide.createIcons();

// ===== Animate on load =====
document.querySelectorAll('.fade-up').forEach((el, i) => {
  el.style.animationDelay = (i * 0.06) + 's';
});
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
