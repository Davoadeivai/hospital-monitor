{% extends 'base/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block breadcrumb %}DASHBOARD{% endblock %}

{% block content %}

<!-- ===== PAGE HEADER ===== -->
<div class="page-header fade-up">
  <div class="page-title-group">
    <div class="page-eyebrow">OVERVIEW / REAL-TIME</div>
    <h1 class="page-title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†</h1>
    <p class="page-subtitle">Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ØªÙ…Ø§Ù… ØªØ¬Ù‡ÛŒØ²Ø§Øª â€” Ø¢Ù¾Ø¯ÛŒØª Ù‡Ø± Ûµ Ø«Ø§Ù†ÛŒÙ‡</p>
  </div>
  <div class="flex gap-3">
    <a href="/devices/" class="btn btn-ghost"><i class="fas fa-microchip me-2"></i>ØªØ¬Ù‡ÛŒØ²Ø§Øª</a>
    <a href="/reports/export/" class="btn btn-primary"><i class="fas fa-download me-2"></i>Ú¯Ø²Ø§Ø±Ø´ Excel</a>
  </div>
</div>

<!-- ===== KPI STATS ===== -->
<div class="stat-grid fade-up stagger-1">

  <div class="stat-card accent-green">
    <div class="stat-header">
      <div class="stat-icon-wrap">ğŸŸ¢</div>
      <div class="stat-trend up" id="kpi-trend-online">
        <i class="fas fa-arrow-up" style="font-size:8px"></i>
        <span id="kpi-online-pct">{{ online_pct }}%</span>
      </div>
    </div>
    <div class="stat-value" id="kpi-online">{{ online_devices }}</div>
    <div class="stat-label">Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
    <div class="stat-sub">Ø§Ø² {{ total_devices }} Ø¯Ø³ØªÚ¯Ø§Ù‡ ÙØ¹Ø§Ù„</div>
  </div>

  <div class="stat-card accent-blue">
    <div class="stat-header">
      <div class="stat-icon-wrap">ğŸ”„</div>
      <div class="stat-trend up">
        <i class="fas fa-clock" style="font-size:8px"></i>
        Ø§Ù…Ø±ÙˆØ²
      </div>
    </div>
    <div class="stat-value" id="kpi-cycles">{{ today_cycles }}</div>
    <div class="stat-label">Ø³ÛŒÚ©Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</div>
    <div class="stat-sub" id="kpi-waste">{{ today_waste_kg|floatformat:1 }} kg Ø²Ø¨Ø§Ù„Ù‡</div>
  </div>

  <div class="stat-card accent-amber">
    <div class="stat-header">
      <div class="stat-icon-wrap">âš¡</div>
      <div class="stat-trend up">Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
    </div>
    <div class="stat-value" style="font-size:26px">{{ month_cost_million|floatformat:1 }}M</div>
    <div class="stat-label">Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø§Ù‡ (Ø±ÛŒØ§Ù„)</div>
    <div class="stat-sub">{{ month_kwh|floatformat:0 }} kWh Ù…ØµØ±Ù Ø¨Ø±Ù‚</div>
  </div>

  <div class="stat-card {% if critical_alerts > 0 %}accent-red{% else %}accent-green{% endif %}">
    <div class="stat-header">
      <div class="stat-icon-wrap">{% if critical_alerts > 0 %}ğŸ”´{% else %}âœ…{% endif %}</div>
      {% if critical_alerts > 0 %}
      <div class="stat-trend down"><i class="fas fa-exclamation" style="font-size:8px"></i> Ø¨Ø­Ø±Ø§Ù†ÛŒ</div>
      {% endif %}
    </div>
    <div class="stat-value" id="kpi-alerts">{{ critical_alerts }}</div>
    <div class="stat-label">Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø­Ø±Ø§Ù†ÛŒ</div>
    <div class="stat-sub">{{ month_carbon|floatformat:1 }} kg COâ‚‚ Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
  </div>

</div>

<!-- ===== MAIN GRID ===== -->
<div class="grid-2 mt-6 fade-up stagger-2" style="grid-template-columns: 1fr 380px; gap: var(--space-5);">

  <!-- LEFT: Chart + Devices -->
  <div class="flex flex-col gap-5">

    <!-- 7-day chart -->
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">ğŸ“Š Ø¢Ù…Ø§Ø± Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±</div>
          <div class="panel-subtitle">CYCLES / COST / WASTE</div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-ghost btn-sm chart-toggle active" data-chart="cycles" onclick="switchChart('cycles', this)">Ø³ÛŒÚ©Ù„</button>
          <button class="btn btn-ghost btn-sm chart-toggle" data-chart="cost" onclick="switchChart('cost', this)">Ù‡Ø²ÛŒÙ†Ù‡</button>
          <button class="btn btn-ghost btn-sm chart-toggle" data-chart="waste" onclick="switchChart('waste', this)">Ø²Ø¨Ø§Ù„Ù‡</button>
        </div>
      </div>
      <div class="panel-body" style="padding-top: var(--space-2)">
        <canvas id="weeklyChart" height="80" style="max-height:220px"></canvas>
      </div>
    </div>

    <!-- Devices -->
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">ğŸ–¥ï¸ ÙˆØ¶Ø¹ÛŒØª ØªØ¬Ù‡ÛŒØ²Ø§Øª</div>
          <div class="panel-subtitle" id="devices-updated">LIVE â€” UPDATING</div>
        </div>
        <a href="/devices/" class="btn btn-ghost btn-sm">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</a>
      </div>
      <div class="panel-body" style="padding: 0">
        <table class="data-table" id="devices-table">
          <thead>
            <tr>
              <th>Ø¯Ø³ØªÚ¯Ø§Ù‡</th>
              <th>Ø¨Ø®Ø´</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>
              <th>Ø¯Ù…Ø§ / Ø§Ø­ØªØ±Ø§Ù‚</th>
              <th>Ø¨Ø±Ù‚</th>
              <th>Ø³ÛŒÚ©Ù„ Ø¬Ø§Ø±ÛŒ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="devices-tbody">
          {% for item in devices_data %}
          <tr>
            <td>
              <div class="flex items-center gap-3">
                <span style="font-size:20px">{% if item.device.device_type == 'autoclave' %}ğŸ”¬{% else %}ğŸ”¥{% endif %}</span>
                <div>
                  <div class="td-primary">{{ item.device.name }}</div>
                  <div class="td-mono" style="font-size:10px;color:var(--text-tertiary)">{{ item.device.serial_number }}</div>
                </div>
              </div>
            </td>
            <td class="text-muted" style="font-size:12px">{{ item.device.department|default:'â€”' }}</td>
            <td>
              <div class="device-status-indicator {{ item.device.status }}">
                <div class="status-dot {% if item.device.status == 'online' %}pulse{% endif %}"></div>
                {{ item.device.get_status_display }}
              </div>
            </td>
            <td class="td-mono td-accent" id="td-temp-{{ item.device.pk }}">
              {% if item.last_reading %}
                {% if item.device.device_type == 'autoclave' %}
                  {{ item.last_reading.temperature_c|floatformat:1|default:'â€”' }}Â°C
                {% else %}
                  {{ item.last_reading.combustion_temp_c|floatformat:0|default:'â€”' }}Â°C
                {% endif %}
              {% else %}â€”{% endif %}
            </td>
            <td class="td-mono" style="color:var(--amber)" id="td-power-{{ item.device.pk }}">
              {% if item.last_reading %}{{ item.last_reading.power_consumption_kw|floatformat:1 }} kW{% else %}â€”{% endif %}
            </td>
            <td>
              {% if item.active_cycle %}
              <span class="badge badge-green">
                <span class="status-dot pulse" style="width:5px;height:5px"></span>
                #{{ item.active_cycle.cycle_number }} â€” {{ item.active_cycle.get_status_display }}
              </span>
              {% else %}
              <span style="color:var(--text-tertiary);font-size:12px">â€”</span>
              {% endif %}
            </td>
            <td>
              <a href="/monitor/{{ item.device.pk }}/" class="btn btn-ghost btn-sm">
                <i class="fas fa-eye"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-tertiary)">
            Ù‡ÛŒÚ† Ø¯Ø³ØªÚ¯Ø§Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ â€” <a href="/admin/devices/device/add/" style="color:var(--acid)">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡</a>
          </td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- RIGHT: Alerts + Carbon + Mini stats -->
  <div class="flex flex-col gap-5">

    <!-- Energy Ring -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">ğŸŒ¿ Ø±Ø¯Ù¾Ø§ÛŒ Ú©Ø±Ø¨Ù†</div>
        <div class="badge badge-ghost">Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
      </div>
      <div class="panel-body" style="text-align:center">
        <div style="position:relative;width:140px;height:140px;margin:0 auto var(--space-4)">
          <svg viewBox="0 0 140 140" width="140" height="140">
            <circle cx="70" cy="70" r="60" fill="none" stroke="var(--surface-3)" stroke-width="10"/>
            <circle cx="70" cy="70" r="60" fill="none" stroke="var(--acid)" stroke-width="10"
              stroke-linecap="round"
              stroke-dasharray="377"
              stroke-dashoffset="{{ carbon_ring_offset }}"
              style="transform:rotate(-90deg);transform-origin:70px 70px;transition:stroke-dashoffset 1s ease"
              id="carbon-ring"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
            <div style="font-family:var(--font-display);font-size:24px;font-weight:800;letter-spacing:-2px;color:var(--acid)" id="carbon-val">{{ month_carbon|floatformat:0 }}</div>
            <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-tertiary);letter-spacing:1px">kg COâ‚‚</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-3)">
          <div style="background:var(--surface-2);border-radius:var(--radius-md);padding:var(--space-3);text-align:center">
            <div style="font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--amber)">{{ month_kwh|floatformat:0 }}</div>
            <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-tertiary)">kWh Ø¨Ø±Ù‚</div>
          </div>
          <div style="background:var(--surface-2);border-radius:var(--radius-md);padding:var(--space-3);text-align:center">
            <div style="font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--plasma)">{{ month_water|floatformat:0 }}</div>
            <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-tertiary)">Ù„ÛŒØªØ± Ø¢Ø¨</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Alerts -->
    <div class="panel" style="flex:1;overflow:hidden">
      <div class="panel-header">
        <div>
          <div class="panel-title">ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
          <div class="panel-subtitle">REAL-TIME ALERTS</div>
        </div>
        <a href="/alerts/" class="btn btn-ghost btn-sm">Ù‡Ù…Ù‡</a>
      </div>
      <div style="padding: var(--space-4);display:flex;flex-direction:column;gap:var(--space-2);max-height:400px;overflow-y:auto" id="alerts-feed">
        {% for alert in active_alerts %}
        <div class="alert-item {{ alert.severity }}" id="alert-{{ alert.pk }}">
          <div class="alert-icon">
            {% if alert.severity == 'critical' %}ğŸš¨{% elif alert.severity == 'warning' %}âš ï¸{% else %}â„¹ï¸{% endif %}
          </div>
          <div class="alert-content">
            <div class="alert-title">{{ alert.device.name }}</div>
            <div class="alert-desc">{{ alert.message|truncatechars:70 }}</div>
            <div class="alert-time">{{ alert.created_at|timesince }} Ù¾ÛŒØ´</div>
          </div>
          <button class="alert-resolve-btn" onclick="resolveAlert({{ alert.pk }}, this)" title="Ø±ÙØ¹ Ù‡Ø´Ø¯Ø§Ø±">
            <i class="fas fa-check"></i>
          </button>
        </div>
        {% empty %}
        <div style="text-align:center;padding:var(--space-8);color:var(--text-tertiary)">
          <div style="font-size:32px;margin-bottom:var(--space-3)">âœ…</div>
          <div style="font-family:var(--font-mono);font-size:11px;letter-spacing:1px">ALL CLEAR</div>
        </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>

<!-- ===== BOTTOM ROW: Energy trend ===== -->
<div class="panel mt-6 fade-up stagger-4">
  <div class="panel-header">
    <div>
      <div class="panel-title">âš¡ Ø±ÙˆÙ†Ø¯ Ø§Ù†Ø±Ú˜ÛŒ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡ â€” Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±</div>
      <div class="panel-subtitle">ENERGY & COST TREND</div>
    </div>
    <div class="live-ticker">
      <div class="live-ticker-dot"></div>
      <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary)">LIVE DATA</span>
    </div>
  </div>
  <div class="panel-body" style="padding-top:var(--space-2)">
    <canvas id="energyChart" height="50" style="max-height:180px"></canvas>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const chartData = {{ chart_data|safe }};
const energyData = {{ energy_data|safe }};

// ===== Weekly Chart =====
const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');

const datasets = {
  cycles: {
    label: 'ØªØ¹Ø¯Ø§Ø¯ Ø³ÛŒÚ©Ù„',
    data: chartData.map(d => d.cycles),
    backgroundColor: 'rgba(0,255,136,0.15)',
    borderColor: 'var(--acid)',
    hoverBackgroundColor: 'rgba(0,255,136,0.3)',
    borderRadius: 6,
    borderSkipped: false,
  },
  cost: {
    label: 'Ù‡Ø²ÛŒÙ†Ù‡ (Ù‡Ø²Ø§Ø± Ø±ÛŒØ§Ù„)',
    data: chartData.map(d => d.cost / 1000),
    backgroundColor: 'rgba(255,184,0,0.15)',
    borderColor: '#ffb800',
    hoverBackgroundColor: 'rgba(255,184,0,0.3)',
    borderRadius: 6,
    borderSkipped: false,
  },
  waste: {
    label: 'Ø²Ø¨Ø§Ù„Ù‡ (kg)',
    data: chartData.map(d => d.waste_kg),
    backgroundColor: 'rgba(0,212,255,0.15)',
    borderColor: '#00d4ff',
    hoverBackgroundColor: 'rgba(0,212,255,0.3)',
    borderRadius: 6,
    borderSkipped: false,
  }
};

const weeklyChart = new Chart(weeklyCtx, {
  type: 'bar',
  data: {
    labels: chartData.map(d => d.date),
    datasets: [datasets.cycles]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#0f1419',
        borderColor: 'rgba(255,255,255,0.1)',
        borderWidth: 1,
        titleColor: '#e8edf2',
        bodyColor: '#7a8fa6',
        padding: 12,
        titleFont: { family: "'Space Mono', monospace", size: 11 },
        bodyFont: { family: "'Vazirmatn', sans-serif", size: 12 },
      }
    },
    scales: {
      x: {
        grid: { color: 'rgba(255,255,255,0.04)' },
        ticks: { color: '#445566', font: { family: "'Space Mono', monospace", size: 10 } }
      },
      y: {
        grid: { color: 'rgba(255,255,255,0.04)' },
        ticks: { color: '#445566', font: { family: "'Space Mono', monospace", size: 10 } }
      }
    },
    animation: { duration: 500, easing: 'easeOutQuart' }
  }
});

function switchChart(type, btn) {
  document.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  weeklyChart.data.datasets[0] = datasets[type];
  weeklyChart.update();
}

// ===== Energy Line Chart =====
const energyCtx = document.getElementById('energyChart').getContext('2d');

new Chart(energyCtx, {
  type: 'line',
  data: {
    labels: energyData.map(d => d.date),
    datasets: [
      {
        label: 'Ø¨Ø±Ù‚ (kWh)',
        data: energyData.map(d => d.kwh),
        borderColor: '#ffb800',
        backgroundColor: 'rgba(255,184,0,0.05)',
        borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4,
        yAxisID: 'y',
      },
      {
        label: 'Ù‡Ø²ÛŒÙ†Ù‡ (Ù‡Ø²Ø§Ø± Ø±ÛŒØ§Ù„)',
        data: energyData.map(d => d.cost / 1000),
        borderColor: '#00ff88',
        backgroundColor: 'rgba(0,255,136,0.05)',
        borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4,
        yAxisID: 'y1',
      }
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: {
        position: 'top',
        labels: { color: '#7a8fa6', font: { family: "'Vazirmatn', sans-serif", size: 11 }, boxWidth: 12, boxHeight: 12 }
      },
      tooltip: {
        backgroundColor: '#0f1419', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1,
        titleColor: '#e8edf2', bodyColor: '#7a8fa6', padding: 12,
      }
    },
    scales: {
      x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#445566', font: { family: "'Space Mono', monospace", size: 10 }, maxTicksLimit: 10 } },
      y: { position: 'right', grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#ffb800', font: { family: "'Space Mono', monospace", size: 10 } } },
      y1: { position: 'left', grid: { drawOnChartArea: false }, ticks: { color: '#00ff88', font: { family: "'Space Mono', monospace", size: 10 } } },
    }
  }
});

// ===== Auto-refresh stats every 30s =====
setInterval(async () => {
  try {
    const data = await apiGet('/api/v1/monitoring/stats/');
    document.getElementById('kpi-online').textContent = data.online_devices;
    document.getElementById('kpi-cycles').textContent = data.today_cycles;
    document.getElementById('kpi-alerts').textContent = data.critical_alerts;
    document.getElementById('devices-updated').textContent = 'UPDATED ' + new Date().toLocaleTimeString('fa-IR');
  } catch(e) {}
}, 30000);
</script>
{% endblock %}
